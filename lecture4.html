<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Node.js - Lecture 4</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
		<script src="js/jquery.min.js"></script>
		<script src="js/jquery.scrollzer.min.js"></script>
		<script src="js/jquery.scrolly.min.js"></script>
		<script src="js/skel.min.js"></script>
		<script src="js/skel-layers.min.js"></script>
		<script src="js/init.js"></script>
    <script type="text/javascript">
      function toggleCode (id) {
        var element = $(id);
        if (element.is(':visible')) {
          $(id).slideUp();
        } else {
          $(id).slideDown();
        }

      }
    </script>
		
		<noscript>
			<link rel="stylesheet" href="css/skel.css" />
			<link rel="stylesheet" href="css/style.css" />
			<link rel="stylesheet" href="css/style-xlarge.css" />
		</noscript>

		<style>
			.ac-caption {
				margin: 5px 0px 10px 0px;
				font-size: 13px;
  				text-align: center;
			}

			#header > nav ul li a {
				padding: 0px;
				font-size: 0.8em;
			}

			#one:before {
				background-image: none;
				height: 0em;
			}

			header.major h2 {
				line-height: 1em;
			}

      .hidden-code {
        margin-bottom: 10px;
      }

      .hidden-code .title {
        font-weight: bold;
        margin-bottom: 5px;
        cursor: pointer;
      }

      .hidden {
        display: none;
      }
		</style>

		<!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]-->
	</head>
	<body>
		<div id="wrapper">

			<!-- Header -->
				<section id="header" class="skel-layers-fixed">
					<header>
						
						<h1 id="logo"><a href="#">Node.js - Lecture 4</a></h1>
						
					</header>
					<nav id="nav">
						<ul>
              <li><a href="#one">Security Measures</a></li>
              <li><a href="#two">Cookie Authentication</a></li>
              <li><a href="#six">Exercises</a></li>
						</ul>
						<img src="images/ac-logo.png" alt="">
					</nav>
					<footer>
					</footer>
				</section>

			<!-- Main -->
				<div id="main">

          <!-- One -->
          <section id="one">
            <div class="container">
              <header class="major">
                <h2>Security Measures</h2>
              </header>

              <p align="justify">
                As we well know the web has several flaws and security issues which we try to protect against every day.
                Among them we have XSS (Cross-site scripting), Session Hijack and Cross-Origin Resource Sharing. In 
                short sentences we can describe each of them as:
              </p>

              <ul>
                <li>
                  <b>XSS</b>: Cross-Site Scripting is when a user tries to inject executable scripts into your site to 
                  try to get sensitive data, do malicious actions into you domain or into other users computers. This 
                  kind of security breach is due to lack of validation by the application in question;
                </li>
                <li>
                  <b>Session Hijacking</b>: is when a cracker steals an user's session to pretend to be him to do 
                  malicous actions or steal sensitive data. It can be done using <i>XSS</i>, a <i>Malware</i>, <i>
                  fixation</i> or <i>sidejacking</i>. It consists of an attacker getting the user's cookie/
                  authentication token an use it to access the service/application;
                </li>
                <li>
                  <b>CORS</b>: Cross-Origin Resource Sharing standard is a set of headers that grant different domians 
                  access to a different domain than which they are from. For instance, a website at http://domain.com 
                  links a image from http://domainX.com, and the last domain allows for external clients get its 
                  resources.
                </li>
              </ul>

              <p align="justify">
                So, every time we build a web application we must be aware of these flaws and fight against them, as 
                hard as we can! Now is the time to ask: Andr√©, how can we fight against tem? No rush, take your time 
                to ask, don't be shy, I'm very friendly.
              </p>

              <p align="justify">
                Good question! How? Well, that is not a easy task, but it is feasible. First of all you need to do in
                order to defend yourself is to take some self-defense lessons, kung-fu and jiu jitsu are good
                choises... ops! Wrong class!
              </p>

              <p align="justify">
                One more time... How? Well, you can start making your backend fool-proof! And to do that you should 
                always validate all client's/requester's input data. You can even go one step further and validate
                your output value after processing a request.
              </p>

              <p align="justify">
                Easier said than done! Well, that is not totally true. It has always been a good practice to validate
                all input data in the controllers of an API. Create well defined business rules helps a lot in this
                kind of situations. So you might consider creating regular expressions for all of your inputs.
              </p>

              <p align="justify">
                You might be asking about how can you validate your output. For pure services, which do not provide
                webpages, it is easier to check this, as you can guess is just to validate your data. However, for HTML
                it might be trickier, you might have to escape dangerous HTML and such. The good news is that some 
                HTML templating framework already do this kind of work for you, for example Handlebars. All variables
                added to the template inside the double brackets <i>{{}}</i> are escaped.
              </p>

              <p align="justify">
                Other useful tool to make it even harder to crackers to do something malicious into your application
                is to create session restrictions and mechanism such authentication tokens (ex: cookies). Those tokens 
                can be ruled by a set of guidelines which will give some headache to break. Some of these rules are:
              </p>

              <ul>
                <li>Authentication cookie;</li>
                <li>Session expiration time;</li>
                <li>Application under HTTPS;</li>
                <li>Persisted client session in backend;</li>
                <li>Encrypted information;</li>
                <li>Encrypted authentication token;</li>
                <li>Encrypted network;</li>
                <li>Authorization layer on backend.</li>
              </ul>

              <p align="justify">
                This is all that I can remember by heart. But what we've learnt so far is that we can use tokens to make
                our application more secure and validate client's input to make it even safer and robust.
              </p>

            </div>
          </section>

          <!-- Two -->
          <section id="two">
            <div class="container">
              <header class="major">
                <h2>Cookie Authentication</h2>
              </header>

              <p align="justify">
                Hello guys, how you doing? I'm feeling great! So great that I want to do some free style coding right now.
                As I said in the first lecture, <b>Node</b> is low level. You might be wandering about how secure <b>Node</b>
                is, how secure my application is right now. I can tell you, it is not secure.
              </p>

              <p align="justify">
                You could make calls from any client, from any browser with any kind of info. <b>Node</b> and <b>Express</b>
                do not provide to us any security layer. So it is our job to add one (it is fun!). One popular way that
                APIs are implementing is token based authentication.
              </p>

              <header>
                <h4>Token Based Authentication</h4>
              </header>

              <p align="justify">
                Why it is so popular? Well, with this concept you can have your RESTful service stay stateless however with
                the ability to know if the requester is trustable or not, using a public network. The core concept is simple:
                Our API will provide to the requester a token. This token is responsible to define if the requester is trustable
                or not. We do this by checking the correctness of this token. As the API is providing this little guy we
                can encrypt information using our favorite algorithm with our hard-to-decode secret that will be private.
                This way no one can fake a token (more or less, there are ways but we are trying to make it as hard as
                possible, not impossible).
              </p>

              <p align="justify">
                Interesting, isn't it? What I want to teach you guys about is <b>Json Web Token</b>.
                Please read <a href="http://code.tutsplus.com/tutorials/token-based-authentication-with-angularjs-nodejs--cms-22543">this article</a>
                before continuing, because I will assume that you know what a JWT is.
              </p>

              <p align="justify">
                After getting our fact right here is what I want to tell you: I will create a token using <b>JWT</b> concept.
                This token will be stored in a cookie where I find a safe place to be stored. This can give me the feature
                of session in my application and security if I'm in a <b>HTTPS</b> environment.
              </p>

              <p align="justify">
                After defining this my application can now search for this cookie to do our authentication feature. I will
                add a middleware into my Dog Service that will be executed before any route that I find reasonable to have it.
                This middleware will get the token from the request's cookie, verify it and then decide if the request should
                be authorized or not. For that I will add two packages from <b>NPM</b>.
              </p>

              <ul>
                <li><a href="https://github.com/expressjs/cookie-parser">Cookie-Parser</a>, or just run "npm install cookie-parser"</li>
                <li><a href="https://github.com/auth0/node-jsonwebtoken">JsonWebToken</a>, or just run "npm install jsonwebtoken"</li>
              </ul>

              <header>
                <h4>The Middleware</h4>
              </header>

              <p align="justify">
                I've already told you what I'm about to code and I don't want to be redundant, so lets get directly to
                what matters. Create a auth.js file with the content below.
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">jwt</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;jsonwebtoken&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">cookieName</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;dogServiceCookie&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">secret</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;HanSoloShootsFirst&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">issuer</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;Peter Griffin&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">twoMinutes</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;2&#39;</span><span style="color: #f8f8f2">;</span>

<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">Auth</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">verifyAuth</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">cookie</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">cookies</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">cookieName</span><span style="color: #f8f8f2">];</span>
    <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cookie</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #66d9ef">try</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">token</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">jwt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">verify</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cookie</span><span style="color: #f8f8f2">,</span>
                                   <span style="color: #a6e22e">secret</span><span style="color: #f8f8f2">,</span>
                                   <span style="color: #f8f8f2">{</span><span style="color: #a6e22e">issuer</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">issuer</span><span style="color: #f8f8f2">,</span>
                                    <span style="color: #a6e22e">ignoreExpiration</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">});</span>
        <span style="color: #66d9ef">return</span> <span style="color: #66d9ef">true</span><span style="color: #f8f8f2">;</span>
      <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">catch</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Request unauthorized. Error decoding token.&#39;</span><span style="color: #f8f8f2">);</span>
        <span style="color: #66d9ef">return</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">;</span>
      <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Request unauthorized. No token available.&#39;</span><span style="color: #f8f8f2">);</span>
      <span style="color: #66d9ef">return</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">;</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">};</span>

  <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">isAuthenticated</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">){</span>

    <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">verifyAuth</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">))</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">();</span>
    <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">sendStatus</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">407</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">};</span>

  <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">signToken</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">payload</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">jwt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">sign</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">payload</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">secret</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">{</span><span style="color: #a6e22e">issuer</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">issuer</span><span style="color: #f8f8f2">,</span>
                                      <span style="color: #a6e22e">expiresInMinutes</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">twoMinutes</span><span style="color: #f8f8f2">});</span>
  <span style="color: #f8f8f2">};</span>
<span style="color: #f8f8f2">};</span>

<span style="color: #a6e22e">module</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">exports</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #a6e22e">Auth</span><span style="color: #f8f8f2">();</span>
</pre></div>
              <div class="ac-caption">Cookie Authentication Middleware</div>

              <p align="justify">
                Now I'm going to add these middleware in the Dog Service code. I will add it in the <i>dog</i> route
                since it has the <b>DELETE</b>, <b>POST</b> and <b>PUT</b> methods.
              </p>

              <!-- HTML generated using hilite.me --><div style="background: #202020; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">bodyParser</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;body-parser&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">parseUrlencoded</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">bodyParser.urlencoded({extend:</span> <span style="color: #6ab825; font-weight: bold">false</span><span style="color: #d0d0d0">});</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">express</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;express&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">router</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">express.Router();</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">dogs</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;./dogs&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">Dog</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;./Dog&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">auth</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;./auth&#39;</span><span style="color: #d0d0d0">);</span>

<span style="color: #d0d0d0">router.use(auth.isAuthenticated);</span>
<span style="color: #d0d0d0">router.use(parseUrlencoded);</span>

<span style="color: #d0d0d0">router.route(</span><span style="color: #ed9d13">&#39;/&#39;</span><span style="color: #d0d0d0">)</span>
    <span style="color: #d0d0d0">.post(</span><span style="color: #6ab825; font-weight: bold">function</span><span style="color: #d0d0d0">(request,</span> <span style="color: #d0d0d0">response){</span>
        <span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">request.body;</span>
        <span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">newDog</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">new</span> <span style="color: #d0d0d0">Dog(data.name);</span>

        <span style="color: #d0d0d0">dogs.push(newDog);</span>

        <span style="color: #d0d0d0">response.status(</span><span style="color: #3677a9">201</span><span style="color: #d0d0d0">).json(</span><span style="color: #ed9d13">&#39;Dog added! Brian loved it.&#39;</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">})</span>
    <span style="color: #d0d0d0">.put(</span><span style="color: #6ab825; font-weight: bold">function</span><span style="color: #d0d0d0">(request,</span> <span style="color: #d0d0d0">response){</span>
        <span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">dog</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">request.body;</span>
        <span style="color: #6ab825; font-weight: bold">for</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">x</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">dogs.length</span> <span style="color: #d0d0d0">-</span> <span style="color: #3677a9">1</span><span style="color: #d0d0d0">;</span> <span style="color: #d0d0d0">x</span> <span style="color: #d0d0d0">&gt;=</span> <span style="color: #3677a9">0</span><span style="color: #d0d0d0">;</span> <span style="color: #d0d0d0">x--)</span> <span style="color: #d0d0d0">{</span>
            <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(dogs[x].getName()</span> <span style="color: #d0d0d0">===</span> <span style="color: #d0d0d0">dog.name)</span> <span style="color: #d0d0d0">{</span>
                <span style="color: #d0d0d0">dogs[x].setName(dog.newName);</span>
            <span style="color: #d0d0d0">}</span>
        <span style="color: #d0d0d0">}</span>

        <span style="color: #d0d0d0">response.sendStatus(</span><span style="color: #3677a9">200</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">});</span>

<span style="color: #d0d0d0">router.route(</span><span style="color: #ed9d13">&#39;/:doggyId&#39;</span><span style="color: #d0d0d0">)</span>
    <span style="color: #d0d0d0">.</span><span style="color: #6ab825; font-weight: bold">delete</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">function</span><span style="color: #d0d0d0">(request,</span> <span style="color: #d0d0d0">response){</span>
        <span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">doggyId</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">request.params.doggyId;</span>

        <span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">dog</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">dogs.splice(doggyId,</span> <span style="color: #3677a9">1</span><span style="color: #d0d0d0">)[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">];</span>

        <span style="color: #d0d0d0">response.json(dog);</span>
    <span style="color: #d0d0d0">});</span>

<span style="color: #d0d0d0">module.exports</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">router;</span>
</pre></div>

              <div class="ac-caption">Dog Service With Authentication</div>

              <p align="justify">
                Now I will create a login route.
              </p>

              <!-- HTML generated using hilite.me --><div style="background: #202020; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">express</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;express&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">router</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">express.Router();</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">dogs</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;./dogs&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">auth</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;./auth&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">bodyParser</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;body-parser&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">parseUrlencoded</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">bodyParser.urlencoded({extended:</span> <span style="color: #6ab825; font-weight: bold">false</span><span style="color: #d0d0d0">});</span>

<span style="color: #d0d0d0">router.route(</span><span style="color: #ed9d13">&#39;/&#39;</span><span style="color: #d0d0d0">)</span>
    <span style="color: #d0d0d0">.post(parseUrlencoded,</span> <span style="color: #6ab825; font-weight: bold">function</span><span style="color: #d0d0d0">(request,</span> <span style="color: #d0d0d0">response){</span>
        <span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">request.body;</span>

        <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(data</span> <span style="color: #d0d0d0">&amp;&amp;</span> <span style="color: #d0d0d0">data.doggyId</span> <span style="color: #d0d0d0">&amp;&amp;</span> <span style="color: #d0d0d0">data.doggyId</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">dogs.length)</span> <span style="color: #d0d0d0">{</span>
            <span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">dog</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">dogs[data.doggyId];</span>
            <span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">payload</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">{name:</span> <span style="color: #d0d0d0">dog.getName(),</span> <span style="color: #d0d0d0">id:</span> <span style="color: #d0d0d0">data.doggyId};</span>
            <span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">token</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">auth.signToken(payload);</span>
            <span style="color: #999999; font-style: italic">// set the cookie on the response</span>
            <span style="color: #d0d0d0">response.cookie(</span><span style="color: #ed9d13">&quot;dogServiceCookie&quot;</span> <span style="color: #d0d0d0">,token);</span>
            <span style="color: #d0d0d0">response.status(</span><span style="color: #3677a9">200</span><span style="color: #d0d0d0">).json(token);</span>
        <span style="color: #d0d0d0">}</span><span style="color: #6ab825; font-weight: bold">else</span><span style="color: #d0d0d0">{</span>
            <span style="color: #d0d0d0">response.sendStatus(</span><span style="color: #3677a9">403</span><span style="color: #d0d0d0">);</span>
        <span style="color: #d0d0d0">}</span>
    <span style="color: #d0d0d0">});</span>

<span style="color: #d0d0d0">module.exports</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">router;</span>
</pre></div>

              <div class="ac-caption">loginRoute.js</div>

              <!-- HTML generated using hilite.me --><div style="background: #202020; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">express</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;express&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">app</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">express();</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">dogRoute</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;./dogRoute&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">goodDogRoute</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;./goodDogRoute&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">wiggleRoute</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;./wiggleRoute&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">loginRoute</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;./loginRoute&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">var</span> <span style="color: #d0d0d0">cookieParser</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">require(</span><span style="color: #ed9d13">&#39;cookie-parser&#39;</span><span style="color: #d0d0d0">);</span>

<span style="color: #d0d0d0">app.use(cookieParser());</span>
<span style="color: #d0d0d0">app.use(</span><span style="color: #ed9d13">&#39;/dog&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">dogRoute);</span>
<span style="color: #d0d0d0">app.use(</span><span style="color: #ed9d13">&#39;/goodDog&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">goodDogRoute);</span>
<span style="color: #d0d0d0">app.use(</span><span style="color: #ed9d13">&#39;/wiggle&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">wiggleRoute);</span>
<span style="color: #d0d0d0">app.use(</span><span style="color: #ed9d13">&#39;/login&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">loginRoute);</span>

<span style="color: #d0d0d0">app.listen(</span><span style="color: #3677a9">8080</span><span style="color: #d0d0d0">,</span> <span style="color: #6ab825; font-weight: bold">function</span><span style="color: #d0d0d0">(){</span>
    <span style="color: #d0d0d0">console.log(</span><span style="color: #ed9d13">&#39;Listening on port 8080...&#39;</span><span style="color: #d0d0d0">);</span>
<span style="color: #d0d0d0">});</span>
</pre></div>

              <div class="ac-caption">Adding Login Route To Our Application</div>

              <p align="justify">
                That is all it takes. Now we can test it to see if our operations over Dog Services are working.
                First of all do a POST call to http://localhost:8080/login , with a doggyId param. It will create a auth cookie on your response, which you can use on the next calls to http://localhost:8080/dog .
              </p>
            </div>
          </section>

          <!-- Six -->
          <section id="six">
            <div class="container">
              <header class="major">
                <h2>Exercises</h2>
              </header>

              <p align="justify">
                I've created another branch named <b>Lecture 4</b> in the <a href="https://github.com/andrebot/Lecture2-NodeExpressAC">same repository</a>
                that we used in <a href="/acbook-nodejs/lecture3.html#three">Lecture 3: Exercises</a>. Please move all the
                code that you did in the master branch and move it to this new branch.
              </p>

              <header>
                <h4>Exercise 1:</h4>
              </header>

              <p align="justify">
                Using the server created at <a href="/acbook-nodejs/lecture3.html#three">Lesson 3: Exercises</a> create
                a <b>Grunt</b> task to use <b>nodemon</b> to bounce our server.
              </p>

              <header>
                <h4>Exercise 2:</h4>
              </header>

              <p align="justify">
                Using the same code from last exercise create Unit Tests for your routes (Using the same stack as the
                example in <a href="/acbook-nodejs/lecture3.html#two">Test</a>).
              </p>

              <header>
                <h4>Exercise 3:</h4>
              </header>

              <p align="justify">
                Using the same code from last exercise create a task to run your test cases automatically.
              </p>

              <header>
                <h4>Exercise 4:</h4>
              </header>

              <p align="justify">
                Using the same code from last exercise add a coverage feature for your source code.
              </p>

              <header>
                <h4>Exercise 5:</h4>
              </header>

              <p align="justify">
                Using the same code from last exercise create a login feature that validates your user by email and
                password. Your login route should be <b>localhost:3000/login</b>. You should use <b>JSON Web Token</b>
                concepts. Your token should expire in one day. Your payload must have these info:

                <ul>
                  <li>name;</li>
                  <li>role(admin or user);</li>
                  <li>issuer;</li>
                </ul>
              </p>

              <header>
                <h4>Exercise 6:</h4>
              </header>

              <p align="justify">
                Using the same code from last exercise create a new route that get the info form the logged user.
                Your route should be <b>http://localhost:3000/me</b>
              </p>

              <header>
                <h4>Exercise 7:</h4>
              </header>

              <p align="justify">
                Using the same code from last exercise add Authorizaton and Athentication to your user routes:

                <ul>
                  <li>List all users should require authentication;</li>
                  <li>Get logged user should require authentication;</li>
                  <li>Get user should require authentication;</li>
                  <li>Delete user should require authentication and the logged user should be an Admin;</li>
                  <li>Change user's password should require authentication;</li>
                </ul>
              </p>

              <header>
                <h4>Exercise 8:</h4>
              </header>

              <p align="justify">
                <b>CHALLENGE:</b> Using the same code from last exercise implement complete new set of routes for friendship.
                You should creates all routes and the friendshipDAO (you should use the same concept applied to userDAO).
                You should implement this routes:
              </p>

              <ul>
                <li>http://localhost:3000/friendships/ - GET - list all friendships - Require Authentication;</li>
                <li>http://localhost:3000/friendships/me - GET - list logged user friendships - Require Authentication;</li>
                <li>http://localhost:3000/friendships/:friendId - GET - get friendship with a user - Require Authentication;</li>
                <li>http://localhost:3000/friendships/:friendId - POST - send friend request to a user - Require Authentication;</li>
                <li>http://localhost:3000/friendships/:friendId - PUT - accept friend request - Require Authentication;</li>
                <li>http://localhost:3000/friendships/:friendId - delete - reject friend request - Require Authentication;</li>
                <li>http://localhost:3000/friendships/:friendId/block - GET - block user - Require Authentication;</li>
                <li>http://localhost:3000/friendships/:friendId/block - GET - unblock user - Require Authentication;</li>
              </ul>

              <p align="justify">
                Your friendshipDao should have this methods:
              </p>

              <ul>
                <li>getFriendship = function(id, succesCB, failCB)</li>
                <li>getFriendshipByUserId = function(userId, friendId, successCB, failCB) </li>
                <li>listAllFriendships = function(successCB, failCB)</li>
                <li>listAllMyFriendships = function(userId, successCB, failCB)</li>
                <li>createFriendship = function(userId, friendId, successCB, failCB)</li>
                <li>updateFriendshipProperty = function(userId, friendId, property, value, successCB, failCB)</li>
                <li>updateFriendshipPropertyById = function(id, property, value, successCB, failCB)</li>
                <li>updateFriendshipStatus = function(id, status, successCB, failCB)</li>
              </ul>

              <p align="justify">
                Your friendship model should have this attributes:
              </p>

              <ul>
                <li>status: number</li>
                <li>userRequested: id</li>
                <li>userRequester: id</li>
                <li>blockUserRequested: id</li>
                <li>blockUserRequester: id</li>
              </ul>
            </div>
          </section>
        </div>

      <!-- Footer -->
      <section id="footer">
        <div class="container">
          <ul class="copyright">
            <li>&copy; Avenue Code. All rights reserved.</li>
            <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
          </ul>
        </div>
      </section>
		</div>
	</body>
</html>